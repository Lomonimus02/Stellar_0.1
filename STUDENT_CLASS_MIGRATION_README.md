# Миграция: Один студент - один класс

## Описание изменений

Данная миграция изменяет логику системы так, чтобы каждый студент мог состоять только в одном классе одновременно.

## Что изменилось

### База данных
- Добавлено уникальное ограничение на поле `student_id` в таблице `student_classes`
- Удалены дублирующиеся записи (если студент был в нескольких классах, оставлена только последняя запись)

### Серверная часть
- Обновлена логика `addStudentToClass()` - теперь автоматически удаляет студента из предыдущего класса
- Добавлены методы `removeStudentFromClass()`, `removeStudentFromAllClasses()`, `getStudentCurrentClass()`
- Добавлен API endpoint `DELETE /api/student-classes` для удаления студента из класса
- Обновлена логика создания пользователей - теперь берется только первый класс из массива

### Клиентская часть
- Изменен интерфейс создания/редактирования студентов: вместо множественного выбора классов - одиночный
- Обновлена страница управления студентами в классах
- Добавлена возможность удаления студента из класса
- Обновлены тексты интерфейса для отражения новой логики

## Инструкции по применению

### 1. Тестирование текущего состояния
```bash
npm run test:student-classes
```
Этот скрипт покажет текущее состояние связей студент-класс и выявит студентов, состоящих в нескольких классах.

### 2. Применение миграции
```bash
npm run migrate:student-classes
```
Этот скрипт:
- Удалит дублирующиеся записи (оставит только последнюю для каждого студента)
- Добавит уникальное ограничение на `student_id`

### 3. Проверка после миграции
```bash
npm run test:student-classes
```
Повторно запустите тест, чтобы убедиться, что миграция прошла успешно.

### 4. Перезапуск сервера
После применения миграции перезапустите сервер:
```bash
npm run dev
```

## Важные замечания

### Обратная совместимость
- API endpoints остались теми же
- Клиентский код обновлен для работы с новой логикой
- Старые данные сохранены (удалены только дублирующиеся записи)

### Поведение системы
- При переводе студента в новый класс он автоматически удаляется из предыдущего
- В интерфейсе создания студента можно выбрать только один класс
- В интерфейсе редактирования студента отображается текущий класс (если есть)

### Откат изменений
Если нужно откатить изменения:
1. Удалите уникальное ограничение: `ALTER TABLE student_classes DROP CONSTRAINT unique_student_class;`
2. Откатите изменения в коде до предыдущей версии

## Файлы, затронутые изменениями

### Серверная часть
- `shared/schema.ts` - добавлено уникальное ограничение
- `server/db-storage.ts` - обновлены методы работы со студентами и классами
- `server/storage.ts` - обновлены методы для совместимости
- `server/routes.ts` - добавлен DELETE endpoint, обновлена логика создания пользователей

### Клиентская часть
- `client/src/pages/users.tsx` - изменен интерфейс создания/редактирования студентов
- `client/src/pages/student-class-assignments.tsx` - обновлена страница управления классами

### Миграция
- `migrations/add_unique_student_constraint.sql` - SQL миграция
- `run-student-migration.js` - скрипт для запуска миграции
- `test-student-classes.js` - скрипт для тестирования

## Поддержка

При возникновении проблем:
1. Проверьте логи сервера
2. Убедитесь, что миграция была применена успешно
3. Проверьте, что в базе данных нет конфликтующих записей
